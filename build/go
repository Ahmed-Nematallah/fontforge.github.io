#!/bin/zsh
#
# Run this to build the site.

autoload -U regexp-replace
setopt rematchpcre

markdown() {
	pandoc -f markdown -t html5
	#perl Markdown.pl --html4tags
}

for j in $@; do
	template=$(<templates/fontforge)
	footer=$(<templates/footer.md | tail -n +6 | markdown) 

	# This resets & gets page specific variables
	#
	title=""; bits=""; section=""
	eval $(<$j | grep -B50 -m2 "+++" | head -n -1 | tail -n +2)
	main=$(<$j | tail -n +6 | markdown) #todo: make this get between +++

	# Replace variables
	#
	replace() {
		regexp-replace template "{{ $@ }}" "\$$@"
		# This does search & replace on $template
	}
	replace title
	replace bits
	replace main
	replace footer

	# Print to output
	#
	output="www/$(basename $j .md).html"
	print $template > $output

	# Alert User
	#
	print $output >&2
done
