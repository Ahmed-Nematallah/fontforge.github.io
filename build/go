#!/bin/zsh
#
# Run this to build the site.

autoload -U regexp-replace
setopt rematchpcre

markdown() {
	#pandoc -f markdown -t html5
	perl ./build/Markdown.pl --html4tags
}

template_=$(<templates/fontforge)
footer_=$(<templates/footer.md | tail -n +6 | markdown) 

for j in "$@"; do
	case "$j" in
		*oldchangelog.md) ;; # it hangs so long on this... Move it to a txt?
		*)
			template=$template_
			footer=$footer_
			output="www/$(basename $j .md).html"
			print -n $output" ... " >&2

			# This resets & gets page specific variables
			#
			title=""; bits=""; section=""
			eval $(<"$j" | grep -B50 -m2 "+++" | head -n -1 | tail -n +2)
			main=$(<"$j" | tail -n +6 | markdown) #todo: make this get between +++

			# Replace variables
			#
			replace() {
				regexp-replace template "{{ $@ }}" "\$$@"
				# This does search & replace on $template
			}
			replace title
			replace bits
			replace main
			replace footer

			# Print to output
			#
			print $template > $output

			# Alert User
			#
			print "Done!" >&2
		;;
	esac
done
